{
  "schemaVersion": 1,
  "meta": {
    "testId": "fde3402b24c4819d",
    "testName": "test_annual_cli_pipeline",
    "testClass": "tests/test_e2e.py",
    "status": "FAILED",
    "timestamp": "2026-02-18T05:41:26Z",
    "durationMs": 62,
    "runId": "4857b9b4-821c-4f1c-a61e-460a39e57384",
    "framework": {
      "name": "pytest",
      "version": "8.0.0"
    },
    "runtime": {
      "language": "python",
      "version": "3.11.9",
      "os": "Darwin",
      "arch": "arm64"
    }
  },
  "context": {},
  "steps": [],
  "exception": {
    "type": "AssertionError",
    "message": "assert ('No paystubs found in /private/var/folders/48/qd3ywfp16fn6fnxhq431h7840000gn/T/pytest-of-sasiekumarshanmugam/pytest-8/test_annual_cli_pipeline0/paystubs for year 2025.' == 0 or 'No paystubs found in /private/var/folders/48/qd3ywfp16fn6fnxhq431h7840000gn/T/pytest-of-sasiekumarshanmugam/pytest-8/test_annual_cli_pipeline0/paystubs for year 2025.' is None)\n +  where 'No paystubs found in /private/var/folders/48/qd3ywfp16fn6fnxhq431h7840000gn/T/pytest-of-sasiekumarshanmugam/pytest-8/test_annual_cli_pipeline0/paystubs for year 2025.' = SystemExit('No paystubs found in /private/var/folders/48/qd3ywfp16fn6fnxhq431h7840000gn/T/pytest-of-sasiekumarshanmugam/pytest-8/test_annual_cli_pipeline0/paystubs for year 2025.').code\n +  and   'No paystubs found in /private/var/folders/48/qd3ywfp16fn6fnxhq431h7840000gn/T/pytest-of-sasiekumarshanmugam/pytest-8/test_annual_cli_pipeline0/paystubs for year 2025.' = SystemExit('No paystubs found in /private/var/folders/48/qd3ywfp16fn6fnxhq431h7840000gn/T/pytest-of-sasiekumarshanmugam/pytest-8/test_annual_cli_pipeline0/paystubs for year 2025.').code",
    "stackTrace": "mock_ocr_text = '\\n    ADP STATEMENT\\n    Pay Date: 12/31/2025\\n    Gross Pay  5,000.00  60,000.00\\n    Federal Income Tax  800.00  9,...    Medicare Tax  72.50  870.00\\n    VA State Income Tax  200.00  2,400.00\\n    401(K) Contrib  500.00  6,000.00\\n    '\ntmp_path = PosixPath('/private/var/folders/48/qd3ywfp16fn6fnxhq431h7840000gn/T/pytest-of-sasiekumarshanmugam/pytest-8/test_annual_cli_pipeline0')\ncapsys = <_pytest.capture.CaptureFixture object at 0x1096d2a90>\n\n    @pytest.mark.e2e\n    def test_annual_cli_pipeline(mock_ocr_text, tmp_path, capsys):\n        \"\"\"\n        E2E Pipeline Test.\n        Creates a dummy PDF.\n        Mocks ONLY the low-level OCR function to return fixed text.\n        Runs the full CLI pipeline (file discovery, regex parsing, aggregation, reporting).\n        \"\"\"\n        # 1. Create dummy PDF so file discovery works\n        paystubs_dir = tmp_path / \"paystubs\"\n        paystubs_dir.mkdir()\n        (paystubs_dir / \"stub.pdf\").write_text(\"dummy pdf content\")\n    \n        output_json = tmp_path / \"package.json\"\n    \n        # 2. Mock OCR to return text parseable by core.py\n        with patch(\"paystub_analyzer.core.ocr_first_page\", return_value=mock_ocr_text):\n    \n            # 3. Invoke CLI\n            test_args = [\n                \"paystub-annual\",\n                \"--year\", \"2025\",\n                \"--paystubs-dir\", str(paystubs_dir),\n                \"--package-json-out\", str(output_json),\n            ]\n    \n            with patch(\"sys.argv\", test_args):\n                try:\n>                   annual_main()\n\ntests/test_e2e.py:47: \n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \n\n    def main() -> None:\n        parser = argparse.ArgumentParser(\n            description=\"Build annual paystub ledger, W-2 authenticity check, and filing packet.\"\n        )\n        parser.add_argument(\"--paystubs-dir\", default=\"pay_statements\", help=\"Directory with paystub PDFs.\")\n        parser.add_argument(\"--year\", type=int, required=True, help=\"Tax year to analyze.\")\n        parser.add_argument(\"--w2-json\", type=Path, default=None, help=\"Optional W-2 JSON for cross-verification.\")\n        parser.add_argument(\"--w2-pdf\", type=Path, default=None, help=\"Optional W-2 PDF for OCR-based cross-verification.\")\n        parser.add_argument(\"--render-scale\", type=float, default=2.8, help=\"OCR render scale.\")\n        parser.add_argument(\"--w2-render-scale\", type=float, default=3.0, help=\"W-2 OCR render scale when using --w2-pdf.\")\n        parser.add_argument(\"--tolerance\", type=Decimal, default=Decimal(\"0.01\"), help=\"Comparison tolerance in dollars.\")\n        parser.add_argument(\n            \"--ledger-csv-out\",\n            type=Path,\n            default=None,\n            help=\"CSV output path for chronological ledger.\",\n        )\n        parser.add_argument(\n            \"--package-json-out\",\n            type=Path,\n            default=None,\n            help=\"JSON output path for filing package.\",\n        )\n        parser.add_argument(\n            \"--package-md-out\",\n            type=Path,\n            default=None,\n            help=\"Markdown output path for filing package.\",\n        )\n        parser.add_argument(\n            \"--force\",\n            action=\"store_true\",\n            help=\"Generate package even if safety checks fail (exit code will still be non-zero unless suppressed).\",\n        )\n        args = parser.parse_args()\n    \n        ledger_csv_out = args.ledger_csv_out or Path(f\"reports/paystub_ledger_{args.year}.csv\")\n        package_json_out = args.package_json_out or Path(f\"reports/tax_filing_package_{args.year}.json\")\n        package_md_out = args.package_md_out or Path(f\"reports/tax_filing_package_{args.year}.md\")\n    \n        snapshots = collect_annual_snapshots(\n            paystubs_dir=Path(args.paystubs_dir),\n            year=args.year,\n            render_scale=args.render_scale,\n            psm=6,\n        )\n        if not snapshots:\n>           sys.exit(f\"No paystubs found in {args.paystubs_dir} for year {args.year}.\")\nE           SystemExit: No paystubs found in /private/var/folders/48/qd3ywfp16fn6fnxhq431h7840000gn/T/pytest-of-sasiekumarshanmugam/pytest-8/test_annual_cli_pipeline0/paystubs for year 2025.\n\npaystub_analyzer/cli/annual.py:125: SystemExit\n\nDuring handling of the above exception, another exception occurred:\n\nmock_ocr_text = '\\n    ADP STATEMENT\\n    Pay Date: 12/31/2025\\n    Gross Pay  5,000.00  60,000.00\\n    Federal Income Tax  800.00  9,...    Medicare Tax  72.50  870.00\\n    VA State Income Tax  200.00  2,400.00\\n    401(K) Contrib  500.00  6,000.00\\n    '\ntmp_path = PosixPath('/private/var/folders/48/qd3ywfp16fn6fnxhq431h7840000gn/T/pytest-of-sasiekumarshanmugam/pytest-8/test_annual_cli_pipeline0')\ncapsys = <_pytest.capture.CaptureFixture object at 0x1096d2a90>\n\n    @pytest.mark.e2e\n    def test_annual_cli_pipeline(mock_ocr_text, tmp_path, capsys):\n        \"\"\"\n        E2E Pipeline Test.\n        Creates a dummy PDF.\n        Mocks ONLY the low-level OCR function to return fixed text.\n        Runs the full CLI pipeline (file discovery, regex parsing, aggregation, reporting).\n        \"\"\"\n        # 1. Create dummy PDF so file discovery works\n        paystubs_dir = tmp_path / \"paystubs\"\n        paystubs_dir.mkdir()\n        (paystubs_dir / \"stub.pdf\").write_text(\"dummy pdf content\")\n    \n        output_json = tmp_path / \"package.json\"\n    \n        # 2. Mock OCR to return text parseable by core.py\n        with patch(\"paystub_analyzer.core.ocr_first_page\", return_value=mock_ocr_text):\n    \n            # 3. Invoke CLI\n            test_args = [\n                \"paystub-annual\",\n                \"--year\", \"2025\",\n                \"--paystubs-dir\", str(paystubs_dir),\n                \"--package-json-out\", str(output_json),\n            ]\n    \n            with patch(\"sys.argv\", test_args):\n                try:\n                    annual_main()\n                except SystemExit as e:\n>                   assert e.code == 0 or e.code is None\nE                   AssertionError: assert ('No paystubs found in /private/var/folders/48/qd3ywfp16fn6fnxhq431h7840000gn/T/pytest-of-sasiekumarshanmugam/pytest-8/test_annual_cli_pipeline0/paystubs for year 2025.' == 0 or 'No paystubs found in /private/var/folders/48/qd3ywfp16fn6fnxhq431h7840000gn/T/pytest-of-sasiekumarshanmugam/pytest-8/test_annual_cli_pipeline0/paystubs for year 2025.' is None)\nE                    +  where 'No paystubs found in /private/var/folders/48/qd3ywfp16fn6fnxhq431h7840000gn/T/pytest-of-sasiekumarshanmugam/pytest-8/test_annual_cli_pipeline0/paystubs for year 2025.' = SystemExit('No paystubs found in /private/var/folders/48/qd3ywfp16fn6fnxhq431h7840000gn/T/pytest-of-sasiekumarshanmugam/pytest-8/test_annual_cli_pipeline0/paystubs for year 2025.').code\nE                    +  and   'No paystubs found in /private/var/folders/48/qd3ywfp16fn6fnxhq431h7840000gn/T/pytest-of-sasiekumarshanmugam/pytest-8/test_annual_cli_pipeline0/paystubs for year 2025.' = SystemExit('No paystubs found in /private/var/folders/48/qd3ywfp16fn6fnxhq431h7840000gn/T/pytest-of-sasiekumarshanmugam/pytest-8/test_annual_cli_pipeline0/paystubs for year 2025.').code\n\ntests/test_e2e.py:49: AssertionError"
  },
  "artifacts": {
    "bundleDir": "fde3402b24c4819d_20260218T054126Z",
    "logs": "context.log"
  }
}